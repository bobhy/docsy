{{/* image processing shortcode, emits figure and responsive img
    xfigure (dict ... )
        page .                              invoking page
        src <uri>                           full URL of external image, or substring of file name of local resource (in page bundle).
        link <uri>                          target link for image as a whole.
        alt ""                              alt text for img
        title ""                            markdown text for title (first line) in figure caption
        caption ""                          markdown text for figure caption (also used as alt if alt not specified)
        attr ""                             markdown text for image attribution (float right in figure caption).
                                            Caption and attr form 2nd line in figure caption if title also specified.
        attrlink <uri>                      target link for attr text
        aspect_ratio 0.0                    (float height / width) desired aspect ratio of rendered image.  If omitted or 0.0, use image's natural aspect ratio.
        width "100%"                        desired width of figure within its container, using CSS units. *not* img@width, which is always pixels.
        class ""                            applied to figure tag
        sizes (slice 400 800 1200 1500)     image resize breakpoints (slice of ints)

    based on
    - https://cpbotha.net/2020/05/02/drop-in-replacement-for-hugo-figure-shortcode-with-img-srcset-support/
    - original srcset img shortcode from: https://laurakalbag.com/processing-responsive-images-with-hugo/
    - original hugo figure shortcode from: https://github.com/gohugoio/hugo/blob/master/tpl/tplimpl/embedded/templates/shortcodes/figure.html
    - no unnecessary resizes and more nudges by St√©fan van der Walt https://mentat.za.net/
    - mashing together and srcset logic fixes by Charl P. Botha https://cpbotha.net/

*/}}

{{- $args := (merge (dict "aspect_ratio" 0.0 "width" "100%" "class" "" "sizes" (slice 400 800 1200 1500)) .) }} {{/* default width and height */}}
{{/* get file that matches the filename as specified as src="" in shortcode */}}
{{- $src := ($args.page).Resources.GetMatch (printf "*%s*" $args.src) -}}
{{/* partial "debug.html" (slice "args" $args "src" $src) */}}
{{- if (or $src (and $args.src (findRE "^http.*" $args.src))) -}}
<figure {{ with $args.class }} class="mb-0 {{ . }}"{{ end }} style="max-width:{{ $args.width }};">
    {{- if $args.link -}}
        <a href="{{ $args.link }}"{{ with $args.target }} target="{{ . }}"{{ end }}{{ with $args.rel }} rel="{{ . }}"{{ end }}>
    {{- end }}
    <img
        {{- if $src }}
            srcset='
            {{- range $args.sizes -}} {{/* hugo will resize to all of these sizes that are smaller than your original. */}}
                {{- if (eq $args.aspect_ratio 0.0) -}} {{- ($src.Resize (printf "%dx" .)).RelPermalink -}}
                {{- else -}} {{- ($src.Fill (printf "%dx%1.f" . (div . $args.aspect_ratio))).RelPermalink -}}
                {{- end -}}
                {{- (printf " %dw, " .) -}}
            {{- end -}}'
            {{- /* when no support for srcset (old browsers, RSS), we load small (800px) */ -}}
            src='{{ (cond (ge $src.Width 800) ($src.Resize "800x") $src).Permalink }}'
        {{- else -}} {{/* fall back to stock hugo behaviour when image is not available in bundle */}}
            src="{{ $args.src }}"
        {{- end -}}
        {{- if or ($args.alt) ($args.caption) -}}
            alt="{{ with $args.alt }}{{ . }}{{ else }}{{ $args.caption | markdownify| plainify }}{{ end }}"
        {{- end -}}
        style="max-width:100%;"
    /> <!-- Closing img tag -->
    {{- if $args.link }}</a>{{ end -}}
    {{ if or (or ($args.title) ($args.caption)) ($args.attr) }}
        <figcaption>
            {{ with ($args.title) -}}
                <h4>{{ . | markdownify }}</h4>
            {{- end -}}
            {{- if or ($args.caption) ($args.attr) -}}<p style="font-size: 0.8rem">
                {{- $args.caption | markdownify -}}&nbsp;
                {{- with $args.attrlink }}
                    <a href="{{ . }}">
                {{- end -}}
                <span class="float-right">{{- $args.attr | markdownify -}}</span>
                {{- if $args.attrlink }}</a>{{ end }}</p>
            {{- end }}
        </figcaption>
    {{- end }}
</figure>
{{- end -}}
